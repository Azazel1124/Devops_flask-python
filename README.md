# Devops_flask-python-main

## О проекте

Этот проект — пример современной DevOps-инфраструктуры для Python/Flask-приложения. Здесь реализованы лучшие практики автоматизации, мониторинга, логирования, CI/CD и инфраструктуры как кода. Проект предназначен для обучения и демонстрации комплексного подхода к разработке и эксплуатации приложений.

---

## Используемые технологии

- **Flask** — основной web-фреймворк для Python-приложения (игра с угадыванием числа, работа с PostgreSQL).
- **PostgreSQL** — реляционная база данных для хранения пользователей и результатов игр.
- **Docker** — контейнеризация всех компонентов для удобства запуска и изоляции окружения.
- **Docker Compose** — оркестрация многоконтейнерного окружения для локальной разработки и тестирования.
- **Prometheus** — сбор метрик с приложения и сервисов, основа мониторинга.
- **Grafana** — визуализация метрик и логов, централизованный дашбординг.
- **Loki** — система сбора и хранения логов контейнеров.
- **Promtail** — агент для сбора логов из Docker-контейнеров и отправки их в Loki.
- **GitLab CI/CD** — автоматизация тестирования, сборки и деплоя через пайплайн.
- **Terraform** — инфраструктура как код для автоматического создания облачных ресурсов.
- **Kubernetes/Helm** — деплой и управление сервисами в k8s-кластере (пример — nginx).
- **pytest, pytest-cov** — тестирование и покрытие кода.

---

## Как запустить проект локально

1. **Клонируйте репозиторий:**
   ```bash
   git clone <repo_url>
   cd Devops_flask-python-main
   ```
2. **Проверьте переменные окружения:**
   По умолчанию используются значения из docker-compose.yml, но для безопасности рекомендуется использовать .env-файл.
   - DB_HOST, DB_NAME, DB_USER, DB_PASSWORD
   - Flask SECRET_KEY
3. **Запустите все сервисы:**
   ```bash
   docker-compose up -d
   ```
4. **Доступ к сервисам:**
   - Flask-приложение: http://localhost:5000
   - Grafana: http://localhost:3000 (логин/пароль: admin/admin или как указано)
   - Prometheus: http://localhost:9090
   - GitLab: http://localhost:8929

---

## Мониторинг и логирование

- **Prometheus** собирает метрики с Flask-приложения (и других сервисов, если добавить).
- **Grafana** подключена к Prometheus и Loki, позволяет строить дашборды по метрикам и логам.
- **Loki** хранит логи контейнеров, получаемые через **Promtail**.
- **Promtail** автоматически собирает логи из Docker-контейнеров и отправляет их в Loki.
- **log-generator** — сервис для генерации тестовых логов (для проверки связки Loki/Promtail/Grafana).

### Как добавить метрики во Flask

1. Добавьте в requirements.txt:
   ```
   prometheus_flask_exporter
   ```
2. В my_flask.py:
   ```python
   from prometheus_flask_exporter import PrometheusMetrics
   metrics = PrometheusMetrics(app)
   ```
3. После этого Prometheus сможет собирать метрики по адресу http://flask-app:5000/metrics

---

## CI/CD

- В проекте настроен пайплайн GitLab CI/CD (`gitlab-ci.yml`):
  - **Lint**: проверка кода на стиль (flake8)
  - **Test**: запуск тестов с покрытием (pytest, pytest-cov)
  - **Docker**: сборка и запуск контейнеров
- Все этапы автоматизированы, что обеспечивает быстрый feedback и надёжность поставки.
- Рекомендуется хранить секреты и пароли в переменных окружения GitLab, а не в открытом виде.

---

## Инфраструктура как код

- **Terraform** (папка terraform/) позволяет описывать и создавать облачные ресурсы (например, БД, виртуальные машины, сети) декларативно.
- **Kubernetes/Helm** (папка K8s-K0s/) — пример деплоя nginx через Helm-чарт и манифесты для k8s-кластера.
- Такой подход обеспечивает воспроизводимость и масштабируемость инфраструктуры.

---

## Тестирование

- Для тестирования используется **pytest** и **pytest-cov** (папка tests/ и run_tests.sh).
- Запуск тестов локально:
  ```bash
  ./run_tests.sh
  ```
- Тесты автоматически запускаются в CI/CD.

---

## Полезные команды

- Остановить сервисы:
  ```bash
  docker-compose down
  ```
- Просмотреть логи:
  ```bash
  docker-compose logs -f
  ```
- Пересобрать контейнеры:
  ```bash
  docker-compose build --no-cache
  ```

---

## Советы по безопасности

- Не храните пароли и секретные ключи в открытом виде (используйте .env и переменные окружения).
- Для production-окружения используйте отдельные базы данных, уникальные пароли и секреты.
- Ограничьте доступ к Grafana, Prometheus и другим сервисам через firewall или VPN.

---

## Контакты

Автор: <ваше имя или ник>

---

**Если возникнут вопросы по запуску, настройке или расширению проекта — пишите!**
